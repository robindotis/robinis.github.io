<!DOCTYPE html>
<html lang="en-GB">
    <head>
        <meta charset="UTF-8">
        <!-- See: https://www.w3schools.com/css/css_rwd_viewport.asp-->
        <!-- 
            var tasksInline = [
                {
                    "localid": "ts0",
                    "id": "10001",
                    "name": "Translation 1",
                    "pages": "8",
                    "startDate": "2023-02-14",
                    "endDate": "2023-02-16"
                },
                {
                    "localid": "ts1",
                    "id": "10002",
                    "name": "Translation 2",
                    "pages": "26",
                    "startDate": "2023-2-15",
                    "endDate": "2023-02-17"
                },
                {
                    "localid": "ts2",
                    "id": "10003",
                    "name": "Translation 3",
                    "pages": "41",
                    "startDate": "2023-02-16",
                    "endDate": "2023-02-19"
                },
                {
                    "localid": "ts3",
                    "id": "10004",
                    "name": "Translation 4",
                    "pages": "8",
                    "startDate": "2023-02-15",
                    "endDate": "2023-03-18"
                },
                {
                    "localid": "ts4",
                    "id": "10005",
                    "name": "Translation 5",
                    "pages": "1",
                    "startDate": "2023-2-15",
                    "endDate": "2023-02-17"
                },
                {
                    "localid": "ts5",
                    "id": "10006",
                    "name": "Translation 6",
                    "pages": "3",
                    "startDate": "2023-2-15",
                    "endDate": "2023-02-17"
                },
                {
                    "localid": "ts6",
                    "id": "10007",
                    "name": "Translation 7",
                    "pages": "3",
                    "startDate": "2023-2-15",
                    "endDate": "2023-02-17"
                },
                {
                    "localid": "ts7",
                    "id": "10008",
                    "name": "Translation 8",
                    "pages": "1",
                    "startDate": "2023-2-15",
                    "endDate": "2023-02-17"
                }
            ];
        -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Task planner</title>

        <style>
            td {
                border: 1px solid #000;
                vertical-align: top;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>Translation planner</h1>
        </header>
        <main>
            <h2>Messages</h2>
            <span id="message">Planning loaded</span>
            <h2>Tasks</h2>
            <div id="tasks">
                <div id="forms">
                    <form id="form0" onsubmit="return processForm(event)"></form>
                </div>
                <table>
                    <thead>
                        <th><label id="task-id">Your Id</label></th>
                        <th><label id="task-name">Name</label></th>
                        <th><label id="task-pages">Pages</label></th>
                        <th><label id="task-due">Due date</label></th>
                        <th><label id="task-submit">Submit</label></th>
                    </thead>
                    <tbody id="taskstable">
                        <tr>
                            <td>
                                <input form="form0" aria-labelledby="task-id" name="task-id" type="text" required size="2">
                            </td>
                            <td>
                                <input form="form0" aria-labelledby="task-name" name="task-name" type="text" required size="10">
                            </td>
                            <td>
                                <input form="form0" aria-labelledby="task-pages" name="task-pages" type="number"  step="1" required>
                            </td>
                            <td>
                                <input form="form0" aria-labelledby="task-date" name="task-date" type="date" required>
                            </td>
                            <td>
                                <input form="form0" name="task-submit" type="submit" value="Add task">
                            </td>
                        </tr>
                    </tbody>
                </table>
                <h3>JSON</h3>
                <p>
                    Copy and store in case loose browser localstorage
                </p>
                <code id="json">

                </code>
                <form id="jsonForm" onsubmit="processJSON(event);">
                    <label for="json-tasks">Paste saved JSON</label>
                    <br/>
                    <textarea name="json-tasks" id="json-tasks" cols="100" rows="5"></textarea>
                    <br/>
                    <input type="submit" value="Save JSON tasks" />                    
                </form>
            </div>
            <template id="taskForm">
                <form id="form" onsubmit="return processForm(event);"></form>
            </template>
            <template id="taskInputs">
                <tr>
                    <td>
                        <input form="form" name="task-localid" type="text" required readonly hidden>
                        <input form="form" aria-labelledby="task-id" name="task-id" type="text" required size="2">
                    </td>
                    <td>
                        <input form="form" aria-labelledby="task-name" name="task-name" type="text" required size="10">
                    </td>
                    <td>
                        <input form="form" aria-labelledby="task-pages" name="task-pages" type="number" step="1" required>
                    </td>
                    <td>
                        <input form="form" aria-labelledby="task-date" name="task-date" type="date" required>
                    </td>
                    <td>
                        <input form="form" name="task-submit" type="submit" value="Update task">
                    </td>
                </tr>
            </template>
            <h2>Holidays</h2>
            <form id="holiday" onsubmit="processHolidays(event);">
                <label for="start-date">Start</label>
                <input type="date" id="start-date" name="start-date">
                <label for="end-date">End</label>
                <input type="date" id="end-date" name="end-date">
                <input type="submit">
            </form>
            <h2>Planning</h2>
            <table>
                <thead>
                    <th>Day</th>
                    <th>Task Id</th>
                    <th>Task Name</th>
                    <th>Hours</th>
                    <th>Total Hours</th>
                </thead>
                <tbody id="planner">
                </tbody>
            </table>
            <template id="day">
                <tr>
                    <td>
                    </td>
                    <td>
                    </td>
                    <td>
                    </td>
                    <td>
                    </td>
                    <td>
                    </td>
                </tr>
            </template>
        </main>
        <footer>
            <p>
                Offered without any warranty or guarantee about the accuracy. Good luck!
            </p>
        </footer>

        <script>
            const HOLIDAY_ADDED = "Holiday added";
            const HOLIDAY_NOT_ADDED_1 = "Holiday not added because 'Start date', 'End date' or both are not set.";
            const HOLIDAY_NOT_ADDED_2 = "Holiday not added, because 'End date' before 'Start date'";

            function processHolidays(e) {
                var startDate = document.getElementById("start-date").value;
                var endDate = document.getElementById("end-date").value;
                var msg = "";
                var resetHolidayForm = false;

                //check end date equal or larger than start date
                if (startDate == "" || endDate == ""){
                    msg = HOLIDAY_NOT_ADDED_1;
                    resetHolidayForm = true;
                }
                else if((new Date(endDate)) < (new Date(startDate))) {
                    msg = HOLIDAY_NOT_ADDED_2;
                    resetHolidayForm = true;
                }
                else {
                    msg = HOLIDAY_ADDED;

                    var holidayRange = {};
                    holidayRange["start-date"] = startDate.trim();
                    holidayRange["end-date"] = endDate.trim();

                    if(!(localStorage.getItem("holidays") === null)){
                        var jsonHolidays = localStorage.getItem("holidays");
                        //alert(jsonTasks);
                        holidays = JSON.parse(jsonHolidays);
                    }
                    holidays.push(holidayRange);
                    localStorage.setItem("holidays",JSON.stringify(holidays));
                }

                if (resetHolidayForm) {
                    document.getElementById("start-date").value = startDate;
                    document.getElementById("end-date").value = endDate;
                }
                //localStorage.setItem("tasks",document.getElementById("json-tasks").value);
                localStorage.setItem("msg",msg);
            }

            function processJSON(e) {
                localStorage.setItem("tasks",document.getElementById("json-tasks").value);
                localStorage.setItem("msg","Tasks uploaded successfully");
            }

            function displaySystemMessage(){
                if(!(localStorage.getItem("msg") === null)){
                    var msg = "";
                    if(!(localStorage.getItem("msg") === "")){
                        msg = localStorage.getItem("msg");
                        document.getElementById("message").innerHTML = msg;
                    }

                    //reset holiday form if needed
                    if(msg != HOLIDAY_ADDED) {
                        let params = new URLSearchParams(document.location.search);
                        let startDate = params.get("start-date"); 
                        let endDate = params.get("end-date");
                        
                        if (!(startDate === null)) {
                            document.getElementById("start-date").value = startDate;
                        }
                        if (!(endDate === null)) {
                            document.getElementById("end-date").value = endDate;
                        }
                    }

                    localStorage.removeItem("msg");                
                }

            }

            function processForm(e) {
                //retrieve stored values
                //e.preventDefault();
                var formTasks = [];
                var msg = "";
                var theForm = document.getElementById(e.target.id); 
                if(!(localStorage.getItem("tasks") === null)){
                    formTasks = JSON.parse(localStorage.getItem("tasks"));
                }

                //store the tasks
                var task = {};
                if(theForm["task-localid"] === undefined) {
                    console.log("new task")
                    task["localid"] = Math.floor(Date.now() / 1000).toString();
                    msg = "Task added";
                }
                else {
                    console.log("existing task")
                    task["localid"] = theForm["task-localid"].value.trim();
                    //existing task, remove from localstorage, 
                    //  so don't have it twice in array
                    formTasks = formTasks.filter(function(item) {
                                    return item.localid != task["localid"];
                                });
                    msg = "Task updated";
                }
                task["id"] = theForm["task-id"].value.trim();
                task["name"] = theForm["task-name"].value.trim();
                task["pages"] = theForm["task-pages"].value.trim();
                task["endDate"] = theForm["task-date"].value.trim();
                formTasks.push(task);

                //alert(JSON.stringify(formTasks));
                localStorage.setItem("tasks",JSON.stringify(formTasks));
                localStorage.setItem("msg",msg);
                //return false;
            }

            function FormatDate(oDay) {
                return oDay.getFullYear() + "-" + 
                            (oDay.getMonth()+1).toString().padStart(2,0) + "-" + 
                            oDay.getDate().toString().padStart(2,0);
            }

            function appendTaskRow(sDay, sTask, sTaskHours, sTotalHours, sClass) {
                const tbody = document.querySelector("#planner");
                const template = document.querySelector('#day');
                const clone = template.content.cloneNode(true);

                const theTask = tasks.find(item => item.id === sTask);

                let td = clone.querySelectorAll("td");
                td[0].textContent = sDay;
                td[1].setHTML(sTask);
                td[2].setHTML(sTaskHours);
                td[3].setHTML(sTaskHours);
                td[4].textContent = sTotalHours;

                if(sClass.length > 0) {
                    let tr = clone.querySelectorAll("tr");
                    tr[0].classList.toggle(sClass)
                }
                
                tbody.appendChild(clone);
            }

            function displayTaskList(taskList) {
                const forms = document.querySelector("#forms");
                const tbody = document.querySelector("#taskstable");
                const templateForm = document.querySelector('#taskForm');
                const templateInputs = document.querySelector('#taskInputs');

                //alert(template.content);
                for (let k = 0; k < taskList.length; k++) {
                    //duplicate the form tags, which need to be outside the table
                    const cloneForm = templateForm.content.cloneNode(true);
                    let form = cloneForm.querySelectorAll("form");
                    form[0].id = form[0].id + (k + 1);
                    forms.appendChild(cloneForm);

                    //duplicate table row with form fields
                    const clone = templateInputs.content.cloneNode(true);
                    let inputs = clone.querySelectorAll("input");

                    //link inputs to the correct form tag
                    for(let i = 0; i < inputs.length; i++) {
                        inputs[i].setAttribute("form","form" + (k + 1));
                    }

                    inputs[0].value = taskList[k].localid.trim();
                    inputs[1].value = taskList[k].id.trim();
                    inputs[2].value = taskList[k].name.trim();
                    inputs[3].value = taskList[k].pages.trim();
                    inputs[4].value = taskList[k].endDate.trim();

                    tbody.appendChild(clone);
                }
            }

            function getUserTaskId(timestamp){
                var theTask = tasks.find(item => item.localid === timestamp);
                return theTask.name + "(" + theTask.id + ")";
            }

            const hoursPerPage = 1;
            const hoursPerDay = 8;
            const pagesPerHour = 1 / hoursPerPage;
            const pagesPerDay = pagesPerHour * hoursPerDay;
            var holidayDays = ["2023-03-01","2023-03-02"];
            var holidays = [];
            var tasks = [];

            displaySystemMessage();

            //only continue if there are tasks in localstorage
            if(!(localStorage.getItem("tasks") === null)){
                var jsonTasks = localStorage.getItem("tasks");
                //alert(jsonTasks);
                tasks = JSON.parse(jsonTasks);
                document.getElementById("json").innerText = jsonTasks;

                tasks.sort((a, b) => {
                    return new Date(a.endDate) - new Date(b.endDate); // descending
                })

                displayTaskList(tasks);

                let totalHours = [];
                let i = 0;
                for (let k = 0; k < tasks.length; k++) {
                    for (let j = 0; j < ((tasks[k].pages) * hoursPerPage); j++) {
                        totalHours[i] = tasks[k].localid;
                        i++;
                        //console.log(i);
                    }
                }
                totalHours.reverse();

                var dayCount = 0;
                var previousDay = "";
                var previousTaskId = ""
            //            var currentTaskHours = 0;
                var counter = 0;
                var WorkToDo = true;
                var firstTaskId = "";
                var cellTaskId = "";
                var cellTaskHours = "";
                var cellClass = "";
                var skipHour = false;
                var previousDayLastTaskOneHour = false;

                while(WorkToDo) {
                    var theDay = new Date(Date.now() + (3600 * 1000 * 24) * dayCount);
                    dayCount++;

                    var currentDay = FormatDate(theDay);
                    var cellDate = currentDay;
                    cellTaskId = "";

                    //check if saturday (6) or sunday (0)
                    if (theDay.getDay() == 0 || 
                        theDay.getDay() == 6) {

                        //add row in the table
                        cellTaskId = "Weekend";
                        cellClass = "nowork";
                        cellTaskHours = "";
                    }
                    //check if holidays
                    else if ((holidayDays.find(item => {return item == FormatDate(theDay)}) || []).length > 0) {
                        //add row in the table
                        cellTaskId = "Holiday";
                        cellClass = "nowork";
                        cellTaskHours = "";

                    }
                    else { 
                        //new working day, start doing the tasks, 
                        //take 8 hours from the array, then move to the next day
                        var hourCount = 0;
                        var taskCurrentDayHours = 0;
                        var firstHourOfDay = true;
                        var newFirstTaskOfDayId = "";
                        var firstTaskOfDayId = "";
                        var currentTaskHours = 0;

                        for (var h = 0; h < hoursPerDay; h++) {
                            var currentTaskId = totalHours.pop();
                            firstTaskOfDayId = currentTaskId;
                            currentTaskHours++;
                            if (h == 0) {
                                //set task id
                                cellTaskId = getUserTaskId(currentTaskId);
                                if (currentTaskId != previousTaskId) {
                                    newFirstTaskOfDayId = currentTaskId;
                                }
                            }
                            else if (currentTaskId != previousTaskId) {
                                //new task
                                
                                //append taskId to cell
                                cellTaskId = cellTaskId + "<br>" + getUserTaskId(currentTaskId);
                                
                                //set hours for previous task
                                if (cellTaskHours == ""){
                                    cellTaskHours = h + " :1";
                                } 
                                else {
                                    cellTaskHours = cellTaskHours + "<br>" + (currentTaskHours - 1) + " :2";
                                }
                                currentTaskHours = 0; 
                            }

                            //last hour in day
                            if (h == (hoursPerDay - 1)) {
                                //append hours
                                if(cellTaskHours == "") {
                                    if(newFirstTaskOfDayId == currentTaskId) {
                                        currentTaskHours--;
                                    }
                                    cellTaskHours = currentTaskHours + " :3";
                                }
                                else {
                                    if(currentTaskHours == 0) {
                                        currentTaskHours++;
                                    }
                                    cellTaskHours = cellTaskHours + "<br>" + currentTaskHours + " :4";
                                }
                            }

                            hourCount++;
                            if (currentTaskId != previousTaskId) {
                                currentTaskHours++;
                            }

                            previousTaskId = currentTaskId;
                            firstHourOfDay = false;

                            if(totalHours.length == 0) {
                                if(h < (hoursPerDay - 1)) {
                                    if(cellTaskHours == "") {
                                        if(firstTaskOfDayId != currentTaskId){
                                            currentTaskHours--;
                                        }
                                        cellTaskHours = currentTaskHours + " :5";
                                    }
                                    else {
                                        if(currentTaskHours == 0) {
                                            currentTaskHours++;
                                        }
                                        cellTaskHours = cellTaskHours + "<br>" + currentTaskHours + " :6";
                                    }
                                }
                                break;
                            }
                        }
                    }
                    
                    counter ++;
                    appendTaskRow(cellDate, cellTaskId, cellTaskHours, counter, cellClass);
                    WorkToDo = (totalHours.length > 0);
                    cellDate = cellTaskId = cellTaskHours = "";
                }

            }
        </script>
    </body>
</html>
